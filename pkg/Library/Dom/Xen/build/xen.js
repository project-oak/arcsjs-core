!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).Xen={})}(this,(function(t){"use strict";const e=function(t,s,n){n=n||[];for(const i in s){const o=s[i];if(o){const s=t.childNodes[i];n[o.key]=s.nodeType===Node.TEXT_NODE?s.parentElement:s,o.sub&&e(s,o.sub,n)}}return n},s=function(t,e,s){if(i(t,e,s,"textContent",t.textContent))return t.textContent="",!0},n=function(t,e,s){if(t.hasAttributes()){let n=!1;for(let a,l=t.attributes,u=l.length-1;u>=0&&(a=l[u]);u--)(o(t,e,s,a.name,a.value)||i(t,e,s,a.name,a.value)||r(t,e,s,a.name,a.value))&&(t.removeAttribute(a.name),n=!0);return n}},i=function(t,e,s,n,i){if("{{"===i.slice(0,2)){"class"===n&&(n="className");let t=i.slice(2,-2);const o=i.includes("=")?"=":":",r=t.split(o);return 2===r.length&&(n=r[0],t=r[1]),a(s,e,"mustaches",n,t),"$"===t[0]&&a(s,"xlate",t,!0),!0}},o=function(t,e,s,n,i){if("on-"===n.slice(0,3))return"{{"===i.slice(0,2)&&(i=i.slice(2,-2),console.warn(`Xen: event handler for '${n}' expressed as a mustache, which is not supported. Using literal value '${i}' instead.`)),a(s,e,"events",n.slice(3),i),!0},r=function(t,e,s,n,i){if("xen:forward"===n)return a(s,e,"events","xen:forward",i),!0},a=function(t,e,s,n,i){const o=t[e]||(t[e]=Object.create(null));(o[s]||(o[s]={}))[n]=i},l=new class{constructor(t){this.cb=t}annotate(t,e,s){return this.notes=e,this.opts=s||0,this.key=this.opts.key||0,e.locator=this._annotateSubtree(t),e}_annotateSubtree(t){let e;for(let s,n=0,i=t.firstChild,o=null;i;n++){const r=this._annotateNode(i);r&&((e=e||{})[n]=r),s=o?o.nextSibling:t.firstChild,s===i?(o=i,i=i.nextSibling):(i=s,n--)}return e}_annotateNode(t){const e=this.key++,s=this.cb(t,e,this.notes,this.opts),n=this._annotateSubtree(t);if(s||n){const t=Object.create(null);return t.key=e,n&&(t.sub=n),t}}}((function(t,e,i,o){let r=!1;switch(o.annotator&&o.annotator(t,e,i,o)&&(r=!0),t.nodeType){case Node.DOCUMENT_FRAGMENT_NODE:break;case Node.ELEMENT_NODE:return r||n(t,e,i);case Node.TEXT_NODE:return r||s(t,e,i)}return r})),u=function(t,e,s){for(const n in t){const i=e[n],o=t[n]&&t[n].events;if(i&&o)for(const t in o){let e=t,n=o[e];n.includes("=")&&([e,n]=n.split("=")),s(i,e,n)}}},c=function(t,e,s,n){e.addEventListener(s,(function(e){return t[n]?t[n](e,e.detail):t.defaultHandler?t.defaultHandler(n,e):void 0}))},d=function(t,e,s,n){const i=e.slice(-1);if("style%"===e||"style"===e||"xen:style"===e)"string"==typeof s?t.style.cssText=s:Object.assign(t.style,s);else if("$"==i){const n=e.slice(0,-1);"boolean"==typeof s||void 0===s?h(t,n,Boolean(s)):t.setAttribute(n,s)}else"textContent"===e?s&&(s.$template||s.template)?p(t,s,n):t.textContent=null==s?"":s:"unsafe-html"===e?t.innerHTML=s||"":"value"===e?t.value!==s&&(t.value=s):t[e]=s},h=function(t,e,s){t[(void 0===s?!t.hasAttribute(e):s)?"setAttribute":"removeAttribute"](e,"")},p=function(t,e,s){let{template:n,models:i}=e;if(n)n=b(n);else{n=t.getRootNode().querySelector(`template[${e.$template}]`)}_(t,s,n,i)},_=function(t,e,s,n){let i,o=t.firstElementChild;for(s&&n&&n&&n.forEach((n,r)=>{if(i=o&&o.nextElementSibling,!o){const n=f(s).events(e);o=n.root.firstElementChild,o&&(o._subtreeDom=n,t.appendChild(o),!s._shapeWarning&&n.root.firstElementChild&&(s._shapeWarning=!0,console.warn("xen-template: subtemplate has multiple root nodes: only the first is used.",s)))}o&&(o._subtreeDom.set(n),o=i)});o;)i=o.nextElementSibling,o.remove(),o=i},f=function(t,s){const n=function(t,e,s){return t._notes||(t._notes=l.annotate(t.content,{},e,s))}(t=b(t),s),i=document.importNode(t.content,!0),o=i.firstElementChild,r=e(i,n.locator);return{root:i,notes:n,map:r,firstElement:o,$(t){return this.root.querySelector(t)},set:function(t){return t&&function(t,e,s,n){if(s)for(const i in t){const o=e[i];if(o){o.scope=s;const e=t[i].mustaches;for(const t in e){const i=e[t];i in s&&d(o,t,s[i],n)}}}}(n,r,t,this.controller),this},events:function(t){return t&&"function"!=typeof t&&(t=c.bind(this,t)),this.controller=t,t&&u(n,r,t),this},forward:function(){return u(n,r,(t,e,s)=>{t.addEventListener(e,n=>{const i={eventName:e,handlerName:s,detail:n.detail,target:n.target};m(t,"xen:forward",i,{bubbles:!0})})}),this},appendTo:function(t){return this.root?t.appendChild(this.root):console.warn("Xen: cannot appendTo, template stamped no DOM"),this.root=t,this}}},m=(t,e,s,n)=>{const i=n||{};i.detail=s;const o=new CustomEvent(e,i);return t.dispatchEvent(o),o.detail},b=t=>"string"==typeof t?g(t):t,g=t=>Object.assign(document.createElement("template"),{innerHTML:t}),v={createTemplate:g,setBoolAttribute:h,stamp:f,takeNote:a},y=()=>Object.create(null),x=(t,e,s)=>{if(t&&clearTimeout(t),e&&s)return setTimeout(e,s)},P=t=>class extends t{constructor(){super(),this._pendingProps=y(),this._props=this._getInitialProps()||y(),this._lastProps=y(),this._state=this._getInitialState()||y(),this._lastState=y()}_getInitialProps(){}_getInitialState(){}_getProperty(t){return this._pendingProps[t]||this._props[t]}_setProperty(t,e){(this._validator||this._wouldChangeProp(t,e))&&(this._pendingProps[t]=e,this._invalidateProps())}_wouldChangeValue(t,e,s){return t[e]!==s}_wouldChangeProp(t,e){return this._wouldChangeValue(this._props,t,e)}_wouldChangeState(t,e){return this._wouldChangeValue(this._state,t,e)}_setProps(t){Object.assign(this._pendingProps,t),this._invalidateProps()}_invalidateProps(){this._propsInvalid=!0,this._invalidate()}_setState(t){let e=!1;const s=this._state;for(const n in t){const i=t[n];this._wouldChangeState(n,i)&&(e=!0,s[n]=i)}if(e)return this._invalidate(),!0}_async(t){return Promise.resolve().then(t.bind(this))}_invalidate(){this._validator||(this._validator=this._async(this._validate))}_getStateArgs(){return[this._props,this._state,this._lastProps,this._lastState]}_validate(){const t=this._getStateArgs();try{Object.assign(this._props,this._pendingProps),this._propsInvalid&&(this._willReceiveProps(...t),this._propsInvalid=!1),this._shouldUpdate(...t)&&(this._ensureMount(),this._doUpdate(...t))}catch(t){console.error(t)}this._validator=null,this._lastProps=Object.assign(y(),this._props),this._lastState=Object.assign(y(),this._state)}_doUpdate(...t){this._update(...t),this._didUpdate(...t)}_ensureMount(){}_willReceiveProps(){}_shouldUpdate(){return!0}_update(){}_didUpdate(){}_debounce(t,e,s){t="_debounce_"+t,this._state[t]=x(this._state[t],e,null!=s?s:16)}},w=t=>class extends t{constructor(){super(),this._mounted=!1,this._root=this,this.__configureAccessors(),this.__lazyAcquireProps()}get _class(){return this.constructor._class||this.constructor}__configureAccessors(){const t=Object.getPrototypeOf(this);if(!t.hasOwnProperty("__$xenPropsConfigured")){t.__$xenPropsConfigured=!0;const e=this._class.observedAttributes;e&&e.forEach(e=>{Object.defineProperty(t,e,{get(){return this._getProperty(e)},set(t){this._setProperty(e,t)}})})}}__lazyAcquireProps(){const t=this._class.observedAttributes;t&&t.forEach(t=>{if(t.toLowerCase()!==t&&console.error(`Xen: Mixed-case attributes are not yet supported, "${this.localName}.observedAttributes" contains "${t}".`),this.hasOwnProperty(t)){const e=this[t];delete this[t],this[t]=e}else this.hasAttribute(t)&&this._setValueFromAttribute(t,this.getAttribute(t))})}_setValueFromAttribute(t,e){this[t]=e}connectedCallback(){this._mount()}_mount(){this._mounted||(this._mounted=!0,this._doMount(),this._didMount())}_doMount(){}_didMount(){}_fire(t,e,s,n){const i=n||{};i.detail=e;const o=new CustomEvent(t,i);return(s||this).dispatchEvent(o),o.detail}},E=t=>class extends t{get template(){const t=this.constructor.module;return t?t.querySelector("template"):""}get host(){return this.shadowRoot||this.attachShadow({mode:"open"})}_doMount(){this._stamp(),this._invalidate()}_stamp(){this.template&&(this._dom=v.stamp(this.template).events(this._listener.bind(this)).appendTo(this.host))}_listener(t,e,s){t.addEventListener(e,t=>{if(this[s])return this[s](t,t.detail,this._props,this._state)})}_doUpdate(...t){this._update(...t);let e=this._render(...t);this._dom&&(Array.isArray(e)&&(e=e.reduce((t,e)=>Object.assign(t,e),Object.create(null))),this._dom.set(e)),this._didUpdate(...t),this._didRender(...t)}_render(){}_didRender(){}},S=E(w(P(HTMLElement))),A=(t,e)=>class extends t{_setProperty(t,s){return A.level>1&&(t in this._pendingProps&&this._pendingProps[t]!==s||this._props[t]!==s)&&e("props",C({[t]:s})),super._setProperty(t,s)}_setState(t){return"object"!=typeof t?(console.warn("Xen::_setState argument must be an object"),!1):super._setState(t)?(A.level>1&&(A.lastFire?e("(fired --\x3e) state",C(t)):e("state",C(t))),!0):void 0}_setImmutableState(t,s){e("state [immutable]",{[t]:s}),super._setImmutableState(t,s)}_fire(t,s,n,i){A.lastFire={name:t,detail:C(s),log:e},e("fire",{[A.lastFire.name]:A.lastFire.detail}),super._fire(t,s,n,i),A.lastFire=null}_doUpdate(...t){return A.level>2&&e("updating..."),super._doUpdate(...t)}_invalidate(){A.level>2&&(this._validator||e("invalidating...")),super._invalidate()}},C=(t,e)=>{if(!t||"object"!=typeof t)return t;const s=Object.create(null);for(const n in t){let i=t[n];e<1&&(i=C(t,(e||0)+1)),s[n]=i}return s};A.level=0;const O=(t,e)=>{let s=e;s||(s={});let n=1,i=(t||document.body).firstElementChild;for(;i;){const t=i.localName;if(customElements.get(t)){const e=i.shadowRoot,o={node:i,props:i._props,state:i._state},r=e?O(e):{};r&&(o.children=r);let a=`${t}${i.id?"#"+i.id:""} (${n++})`;for(;s[a];)a+="_";s[a]=o}O(i,s),i=i.nextElementSibling}return s},j=(t,...e)=>(t[0]+e.map((e,s)=>e+t[s+1]).join("")).trim();v.html=(...t)=>v.createTemplate(j(...t));const N={State:P,Template:v,Element:w,BaseMixin:E,Base:S,Debug:A,setBoolAttribute:v.setBoolAttribute,html:j,walker:O,logFactory:(t,e,s)=>A.level>0?((t,e,s="log")=>console[s].bind(console,"%c"+t,`background: ${e}; color: white; padding: 1px 6px 2px 7px; border-radius: 6px;`))(t,e,s):()=>{},clone:t=>"object"==typeof t?Object.assign(Object.create(null),t):{},nob:y,debounce:x};window.Xen=N;const T=t=>class extends t{set state(t){this._setState(t)}get state(){return this._state}get props(){return this._props}async awaitState(t,e){const s=this._state,n="_await_"+t;if(!s[n]){s[n]=!0;const i=await e();this.state={[t]:i,[n]:!1}}}fire(...t){this._fire(...t)}_getInitialState(){return this.getInitialState&&this.getInitialState()}_update(t,e,s,n){return this.update&&this.update(t,e,s,n)}_render(t,e,s,n){if(this.shouldRender(t,e,s,n))return this.render&&this.render(t,e,s,n)}shouldRender(){return!0}render(t,e){return e}onState(t,e){this._setState({[t.type]:e})}};N.AsyncMixin=T,N.Async=T(N.Base),t.Xen=N,t.XenAsyncMixin=T,Object.defineProperty(t,"__esModule",{value:!0})}));
